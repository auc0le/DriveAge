<?xml version='1.0' standalone='yes'?>
<!DOCTYPE PLUGIN [
  <!ENTITY name      "driveage">
  <!ENTITY author    "Tony Coleman">
  <!ENTITY version   "2025.12.25">
  <!ENTITY build     "20">
  <!ENTITY launch    "Settings/DriveAge">
  <!ENTITY gitURL    "https://raw.githubusercontent.com/auc0le/DriveAge/main">
  <!ENTITY pluginURL "&gitURL;/plugins/&name;.plg">
  <!ENTITY pkgURL    "&gitURL;/archive">
  <!ENTITY pkg       "/boot/config/plugins/&name;/packages">
  <!ENTITY plgpath   "/boot/config/plugins/&name;">
  <!ENTITY emhttp    "/usr/local/emhttp/plugins/&name;">
  <!ENTITY md5       "de11763dfb91bfa7e64ef223f07f113d">
]>

<PLUGIN
  name="&name;"
  author="&author;"
  version="&version;-&build;"
  launch="&launch;"
  pluginURL="&pluginURL;"
  support="https://github.com/auc0le/DriveAge/issues"
  min="6.12.0">

<CHANGES>
##&name;

###2025.11.26
- Initial release
</CHANGES>

<!-- Download Package File -->
<FILE Name="&plgpath;/&name;-&version;-x86_64-&build;.txz" Run="upgradepkg --install-new">
  <URL>&pkgURL;/&name;-&version;-x86_64-&build;.txz</URL>
  <MD5>&md5;</MD5>
</FILE>

<!-- Installation Script -->
<FILE Run="/bin/bash" Method="install">
<INLINE>
<![CDATA[
#!/bin/bash
set +e  # Disable exit on error

echo ""
echo "-----------------------------------------------------------"
echo " Installing DriveAge Plugin..."
echo "-----------------------------------------------------------"
echo ""

# Create configuration directory if it doesn't exist
echo "Creating configuration directories..."
mkdir -p /boot/config/plugins/driveage

# Create cache and log directories
echo "Creating cache and log directories..."
mkdir -p /var/lib/driveage/ratelimit
mkdir -p /var/log
chmod 700 /var/lib/driveage

# Create default configuration if it doesn't exist
if [ ! -f "/boot/config/plugins/driveage/driveage.cfg" ]; then
  echo "Creating default configuration..."
  cat > /boot/config/plugins/driveage/driveage.cfg <<'EOF'
# Display Configuration
DEFAULT_SORT="power_on_hours"
DEFAULT_SORT_DIR="desc"

# Refresh Configuration
AUTO_REFRESH="false"
REFRESH_INTERVAL="300"

# Age Thresholds (in hours)
THRESHOLD_BRAND_NEW="17520"
THRESHOLD_NEWISH="26280"
THRESHOLD_NORMAL="35040"
THRESHOLD_AGED="43800"
THRESHOLD_OLD="52560"

# Display Filters
SHOW_PARITY="true"
SHOW_ARRAY="true"
SHOW_CACHE="true"
SHOW_POOL="true"
SHOW_UNASSIGNED="true"

# Column Visibility
SHOW_TEMPERATURE="true"
SHOW_SMART_STATUS="true"
SHOW_SPIN_STATUS="true"

# JSON API Configuration
API_ENABLED="false"
API_RATE_LIMIT="100"
EOF
fi

# Set permissions
echo "Setting permissions..."
chmod -R 755 /usr/local/emhttp/plugins/driveage
chmod 644 /boot/config/plugins/driveage/driveage.cfg

echo ""
echo "-----------------------------------------------------------"
echo " DriveAge has been installed successfully!"
<<<<<<< HEAD
<<<<<<< HEAD
echo " Version: 2025.12.25 (Build 20)"
=======
echo " Version: 2025.12.25 (Build 20)"
=======
echo " Version: 2025.12.25 (Build 20)"
=======
echo " Version: 2025.12.25 (Build 20)"
>>>>>>> aaaed637b390cb2ebda2af37c0e51d7e3f8f0a8f
>>>>>>> 64b7ffe00dec0956cbf76fcb036e5f01d6ba34a2
echo " Access it at: Settings -> DriveAge"
echo "-----------------------------------------------------------"
echo ""

exit 0
]]>
</INLINE>
</FILE>

<!-- Download Plugin File (must be last for Unraid to recognize plugin as installed) -->
<FILE Name="&plgpath;/&name;.plg">
  <URL>&pluginURL;</URL>
</FILE>

<!-- Removal Script -->
<FILE Run="/bin/bash" Method="remove">
<INLINE>
<![CDATA[
#!/bin/bash

echo ""
echo "-----------------------------------------------------------"
echo " Removing DriveAge Plugin..."
echo "-----------------------------------------------------------"
echo ""

# Remove package
removepkg &name;

# Remove emhttp files
rm -rf &emhttp;

# Optional: Remove configuration (commented out to preserve settings)
# Uncomment the line below if you want to remove settings on uninstall
# rm -rf &plgpath;

# Remove downloaded packages and plugin file
rm -f &plgpath;/*.txz
rm -f &plgpath;/*.md5
rm -f &plgpath;/&name;.plg

echo ""
echo "-----------------------------------------------------------"
echo " DriveAge has been removed."
echo " Configuration files preserved in: &plgpath;"
echo "-----------------------------------------------------------"
echo ""
]]>
</INLINE>
</FILE>

</PLUGIN>
