Menu="DriveAge:1"
Title="Dashboard"
---
<?PHP
/* DriveAge Plugin - Dashboard */
require_once '/usr/local/emhttp/plugins/driveage/include/config.php';
require_once '/usr/local/emhttp/plugins/driveage/include/helpers.php';

$config = loadConfig();
$timestamp = date('Y-m-d H:i:s');

// Helper function to format years without .0 for whole numbers
function formatYears($hours) {
    $years = $hours / 8760;
    // If it's a whole number, return without decimal
    if (floor($years) == $years) {
        return number_format($years, 0);
    }
    // Otherwise return with 1 decimal place
    return number_format($years, 1);
}

// Cache busting version - use simple incrementing version number
$cacheVersion = '2025.12.26-2';
?>
<link rel="stylesheet" href="/plugins/driveage/styles/driveage.css?v=<?= $cacheVersion; ?>">

<!-- Dynamic category color styles -->
<style id="driveage-dynamic-colors">
/* Dynamic colors are now applied via JavaScript from JSON API response */
</style>

<script src="/plugins/driveage/js/dashboard.js?v=<?= $cacheVersion; ?>"></script>
<script src="/plugins/driveage/js/vendor/chart.min.js?v=<?= $cacheVersion; ?>"></script>
<script src="/plugins/driveage/js/charts.js?v=<?= $cacheVersion; ?>"></script>

<div class="driveage-container">
    <div class="driveage-header">
        <div>
            <span id="last-updated" class="last-updated">Loading...</span>
        </div>
        <div class="driveage-controls">
            <button id="refresh-btn" title="Refresh drive data">
                <span>↻</span> Refresh
            </button>
        </div>
    </div>

    <!-- Legend Section -->
    <div class="driveage-legend">
        <div class="legend-item">
            <div class="legend-color age-minimal_risk"></div>
            <span class="legend-label"><?= e(getAgeLabel('minimal_risk', $config)); ?></span>
            <span class="legend-hours">(< <?= e(formatYears($config['THRESHOLD_MINIMAL_RISK'])); ?> years)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color age-low_risk"></div>
            <span class="legend-label"><?= e(getAgeLabel('low_risk', $config)); ?></span>
            <span class="legend-hours">(<?= e(formatYears($config['THRESHOLD_MINIMAL_RISK'])); ?>-<?= e(formatYears($config['THRESHOLD_LOW_RISK'])); ?> years)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color age-moderate_risk"></div>
            <span class="legend-label"><?= e(getAgeLabel('moderate_risk', $config)); ?></span>
            <span class="legend-hours">(<?= e(formatYears($config['THRESHOLD_LOW_RISK'])); ?>-<?= e(formatYears($config['THRESHOLD_MODERATE_RISK'])); ?> years)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color age-elevated_risk"></div>
            <span class="legend-label"><?= e(getAgeLabel('elevated_risk', $config)); ?></span>
            <span class="legend-hours">(<?= e(formatYears($config['THRESHOLD_MODERATE_RISK'])); ?>-<?= e(formatYears($config['THRESHOLD_ELEVATED_RISK'])); ?> years)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color age-high_risk"></div>
            <span class="legend-label"><?= e(getAgeLabel('high_risk', $config)); ?></span>
            <span class="legend-hours">(≥ <?= e(formatYears($config['THRESHOLD_ELEVATED_RISK'])); ?> years)</span>
        </div>
    </div>

    <!-- Charts Section -->
    <div id="charts-container" class="driveage-charts-container">
        <div class="chart-grid">
            <div class="chart-card">
                <h3>Risk Category Distribution</h3>
                <canvas id="risk-chart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Temperature Distribution</h3>
                <canvas id="temperature-chart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Drive Size Distribution</h3>
                <canvas id="size-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Drive data container (will be populated by JavaScript) -->
    <div id="drive-container"></div>

    <!-- Footer Section -->
    <div class="driveage-footer">
        <span id="drive-count">Total Drives: 0</span> |
        DriveAge v2025.11.27
    </div>
</div>

