Menu="DriveAge:2"
Title="Settings"
---
<?PHP
/* DriveAge Plugin - Settings Page */
require_once '/usr/local/emhttp/plugins/driveage/include/config.php';
require_once '/usr/local/emhttp/plugins/driveage/include/helpers.php';
require_once '/usr/local/emhttp/plugins/driveage/include/security.php';

// Load configuration
$config = loadConfig();

// Generate CSRF token
$csrfToken = generateCsrfToken();

// Convert hours to years for display
function hoursToYears($hours) {
    return round($hours / 8760, 1);
}

// Cache busting version - use simple incrementing version number
$cacheVersion = '2025.12.25-24';
?>
<link rel="stylesheet" href="/plugins/driveage/styles/driveage.css?v=<?= $cacheVersion; ?>">

<!-- Dynamic category color styles -->
<style id="driveage-dynamic-colors">
/* Colors are applied client-side for real-time preview updates */
</style>

<!-- Inject default configuration for JavaScript -->
<script>
const DRIVEAGE_DEFAULTS = <?= json_encode(getDefaultConfig()); ?>;
</script>

<script src="/plugins/driveage/js/settings.js?v=<?= $cacheVersion; ?>"></script>
<style>
        .settings-form {
            max-width: 900px;
            margin: 20px 0;
        }

        .settings-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        .settings-section h3 {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group input[type="number"],
        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            max-width: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .form-group .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }

        .threshold-input {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            max-width: 600px;
        }

        .threshold-item {
            padding: 10px;
            border-radius: 4px;
            border: 2px solid #ddd;
        }

        .threshold-item label {
            font-size: 12px;
            font-weight: 600;
        }

        .threshold-item input {
            width: 100%;
            margin-top: 5px;
        }

        .color-preview {
            margin-top: 10px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
        }

        .color-block {
            padding: 10px;
            text-align: center;
            font-size: 11px;
            border-radius: 3px;
        }

        .buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .buttons button,
        .buttons input[type="submit"] {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #666;
            color: white;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            color: #856404;
        }

        .error-box {
            background: #ffe6e6;
            border: 1px solid #ff0000;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            color: #cc0000;
            font-weight: bold;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .category-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }

        .category-card h4 {
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
            font-size: 16px;
            color: #333;
        }

        .category-card .form-row {
            margin-bottom: 12px;
        }

        .category-card .form-row label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #555;
            margin-bottom: 4px;
        }

        .category-card input[type="text"],
        .category-card input[type="number"] {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .category-card input[type="text"]:focus,
        .category-card input[type="number"]:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .threshold-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .threshold-row input[type="number"] {
            flex: 1;
        }

        .threshold-row .unit {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
        }

        .color-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-row input[type="color"] {
            width: 50px;
            height: 35px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            padding: 2px;
        }

        .color-row input[type="color"]:hover {
            border-color: #4CAF50;
        }

        .color-row input[type="color"].duplicate {
            border: 3px solid red;
        }

        .color-preview-inline {
            flex: 1;
            padding: 6px 10px;
            border-radius: 4px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
        }

        .color-hex {
            font-family: monospace;
            font-size: 11px;
            color: #666;
            min-width: 65px;
        }

        .help-text {
            display: block;
            font-size: 11px;
            color: #888;
            margin-top: 3px;
        }

        /* Responsive grid */
        @media (max-width: 1024px) {
            .category-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .category-grid {
                grid-template-columns: 1fr;
            }
        }
</style>

<div class="driveage-container">
        <form method="POST" action="/update.php" target="progressFrame">
            <input type="hidden" name="#file" value="/boot/config/plugins/driveage/driveage.cfg">
            <input type="hidden" name="csrf_token" value="<?= e($csrfToken); ?>">

            <div class="settings-form">
                <!-- Age Categories Section -->
                <div class="settings-section">
                    <h3>Risk Categories</h3>
                    <p>Customize the label, maximum age threshold, and color for each risk category. Categories progress from lowest to highest failure risk based on Annual Failure Rate (AFR) data. Each category must have a unique color, and thresholds must be in ascending order.</p>

                    <div id="color-error" style="display:none;" class="error-box"></div>

                    <div class="category-grid">
                        <!-- Category 1: Minimal Risk -->
                        <div class="category-card">
                            <h4>Category 1: Minimal Risk</h4>
                            <div class="form-row">
                                <label>Label:</label>
                                <input type="text"
                                       name="LABEL_MINIMAL_RISK"
                                       value="<?= e($config['LABEL_MINIMAL_RISK']); ?>"
                                       maxlength="50"
                                       placeholder="Category name"
                                       data-category="minimal_risk"
                                       class="label-input">
                            </div>
                            <div class="form-row">
                                <label>Max Age:</label>
                                <div class="threshold-row">
                                    <input type="number"
                                           class="threshold-years"
                                           data-field="THRESHOLD_MINIMAL_RISK"
                                           value="<?= e(hoursToYears($config['THRESHOLD_MINIMAL_RISK'])); ?>"
                                           min="0"
                                           step="0.1">
                                    <span class="unit">years</span>
                                    <input type="hidden" name="THRESHOLD_MINIMAL_RISK" value="<?= e($config['THRESHOLD_MINIMAL_RISK']); ?>">
                                </div>
                                <small class="help-text">Drives under this age</small>
                            </div>
                            <div class="form-row">
                                <label>Colors:</label>
                                <div class="color-row">
                                    <input type="color"
                                           name="COLOR_MINIMAL_RISK"
                                           value="<?= e($config['COLOR_MINIMAL_RISK']); ?>"
                                           required
                                           data-category="minimal_risk"
                                           title="Background color"
                                           class="color-input bg-color">
                                    <div class="color-preview-inline" data-category="minimal_risk">Preview</div>
                                    <input type="color"
                                           name="TEXTCOLOR_MINIMAL_RISK"
                                           value="<?= e($config['TEXTCOLOR_MINIMAL_RISK']); ?>"
                                           required
                                           data-category="minimal_risk"
                                           title="Text color"
                                           class="color-input text-color">
                                </div>
                            </div>
                        </div>

                        <!-- Category 2: Low Risk -->
                        <div class="category-card">
                            <h4>Category 2: Low Risk</h4>
                            <div class="form-row">
                                <label>Label:</label>
                                <input type="text"
                                       name="LABEL_LOW_RISK"
                                       value="<?= e($config['LABEL_LOW_RISK']); ?>"
                                       maxlength="50"
                                       placeholder="Category name"
                                       data-category="low_risk"
                                       class="label-input">
                            </div>
                            <div class="form-row">
                                <label>Max Age:</label>
                                <div class="threshold-row">
                                    <input type="number"
                                           class="threshold-years"
                                           data-field="THRESHOLD_LOW_RISK"
                                           value="<?= e(hoursToYears($config['THRESHOLD_LOW_RISK'])); ?>"
                                           min="0"
                                           step="0.1">
                                    <span class="unit">years</span>
                                    <input type="hidden" name="THRESHOLD_LOW_RISK" value="<?= e($config['THRESHOLD_LOW_RISK']); ?>">
                                </div>
                                <small class="help-text">Drives under this age</small>
                            </div>
                            <div class="form-row">
                                <label>Colors:</label>
                                <div class="color-row">
                                    <input type="color"
                                           name="COLOR_LOW_RISK"
                                           value="<?= e($config['COLOR_LOW_RISK']); ?>"
                                           required
                                           data-category="low_risk"
                                           title="Background color"
                                           class="color-input bg-color">
                                    <div class="color-preview-inline" data-category="low_risk">Preview</div>
                                    <input type="color"
                                           name="TEXTCOLOR_LOW_RISK"
                                           value="<?= e($config['TEXTCOLOR_LOW_RISK']); ?>"
                                           required
                                           data-category="low_risk"
                                           title="Text color"
                                           class="color-input text-color">
                                </div>
                            </div>
                        </div>

                        <!-- Category 3: Moderate Risk -->
                        <div class="category-card">
                            <h4>Category 3: Moderate Risk</h4>
                            <div class="form-row">
                                <label>Label:</label>
                                <input type="text"
                                       name="LABEL_MODERATE_RISK"
                                       value="<?= e($config['LABEL_MODERATE_RISK']); ?>"
                                       maxlength="50"
                                       placeholder="Category name"
                                       data-category="moderate_risk"
                                       class="label-input">
                            </div>
                            <div class="form-row">
                                <label>Max Age:</label>
                                <div class="threshold-row">
                                    <input type="number"
                                           class="threshold-years"
                                           data-field="THRESHOLD_MODERATE_RISK"
                                           value="<?= e(hoursToYears($config['THRESHOLD_MODERATE_RISK'])); ?>"
                                           min="0"
                                           step="0.1">
                                    <span class="unit">years</span>
                                    <input type="hidden" name="THRESHOLD_MODERATE_RISK" value="<?= e($config['THRESHOLD_MODERATE_RISK']); ?>">
                                </div>
                                <small class="help-text">Drives under this age</small>
                            </div>
                            <div class="form-row">
                                <label>Colors:</label>
                                <div class="color-row">
                                    <input type="color"
                                           name="COLOR_MODERATE_RISK"
                                           value="<?= e($config['COLOR_MODERATE_RISK']); ?>"
                                           required
                                           data-category="moderate_risk"
                                           title="Background color"
                                           class="color-input bg-color">
                                    <div class="color-preview-inline" data-category="moderate_risk">Preview</div>
                                    <input type="color"
                                           name="TEXTCOLOR_MODERATE_RISK"
                                           value="<?= e($config['TEXTCOLOR_MODERATE_RISK']); ?>"
                                           required
                                           data-category="moderate_risk"
                                           title="Text color"
                                           class="color-input text-color">
                                </div>
                            </div>
                        </div>

                        <!-- Category 4: Elevated Risk -->
                        <div class="category-card">
                            <h4>Category 4: Elevated Risk</h4>
                            <div class="form-row">
                                <label>Label:</label>
                                <input type="text"
                                       name="LABEL_ELEVATED_RISK"
                                       value="<?= e($config['LABEL_ELEVATED_RISK']); ?>"
                                       maxlength="50"
                                       placeholder="Category name"
                                       data-category="elevated_risk"
                                       class="label-input">
                            </div>
                            <div class="form-row">
                                <label>Max Age:</label>
                                <div class="threshold-row">
                                    <input type="number"
                                           class="threshold-years"
                                           data-field="THRESHOLD_ELEVATED_RISK"
                                           value="<?= e(hoursToYears($config['THRESHOLD_ELEVATED_RISK'])); ?>"
                                           min="0"
                                           step="0.1">
                                    <span class="unit">years</span>
                                    <input type="hidden" name="THRESHOLD_ELEVATED_RISK" value="<?= e($config['THRESHOLD_ELEVATED_RISK']); ?>">
                                </div>
                                <small class="help-text">Drives under this age</small>
                            </div>
                            <div class="form-row">
                                <label>Colors:</label>
                                <div class="color-row">
                                    <input type="color"
                                           name="COLOR_ELEVATED_RISK"
                                           value="<?= e($config['COLOR_ELEVATED_RISK']); ?>"
                                           required
                                           data-category="elevated_risk"
                                           title="Background color"
                                           class="color-input bg-color">
                                    <div class="color-preview-inline" data-category="elevated_risk">Preview</div>
                                    <input type="color"
                                           name="TEXTCOLOR_ELEVATED_RISK"
                                           value="<?= e($config['TEXTCOLOR_ELEVATED_RISK']); ?>"
                                           required
                                           data-category="elevated_risk"
                                           title="Text color"
                                           class="color-input text-color">
                                </div>
                            </div>
                        </div>

                        <!-- Category 5: High Risk -->
                        <div class="category-card">
                            <h4>Category 5: High Risk</h4>
                            <div class="form-row">
                                <label>Label:</label>
                                <input type="text"
                                       name="LABEL_HIGH_RISK"
                                       value="<?= e($config['LABEL_HIGH_RISK']); ?>"
                                       maxlength="50"
                                       placeholder="Category name"
                                       data-category="high_risk"
                                       class="label-input">
                            </div>
                            <div class="form-row">
                                <label>Max Age:</label>
                                <div class="threshold-row">
                                    <input type="text" value="No limit" disabled style="background: #f5f5f5;">
                                </div>
                                <small class="help-text">All drives above Category 4</small>
                            </div>
                            <div class="form-row">
                                <label>Colors:</label>
                                <div class="color-row">
                                    <input type="color"
                                           name="COLOR_HIGH_RISK"
                                           value="<?= e($config['COLOR_HIGH_RISK']); ?>"
                                           required
                                           data-category="high_risk"
                                           title="Background color"
                                           class="color-input bg-color">
                                    <div class="color-preview-inline" data-category="high_risk">Preview</div>
                                    <input type="color"
                                           name="TEXTCOLOR_HIGH_RISK"
                                           value="<?= e($config['TEXTCOLOR_HIGH_RISK']); ?>"
                                           required
                                           data-category="high_risk"
                                           title="Text color"
                                           class="color-input text-color">
                                </div>
                            </div>
                        </div>
